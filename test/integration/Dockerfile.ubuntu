FROM ubuntu:22.04
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    curl git sudo bash ca-certificates \
    && rm -rf /var/lib/apt/lists/*
# Create test user with sudo
RUN useradd -m -s /bin/bash testuser && \
    echo "testuser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
# Install Go
RUN curl -fsSL https://go.dev/dl/go1.23.6.linux-amd64.tar.gz | tar -C /usr/local -xz
ENV PATH="/usr/local/go/bin:${PATH}"
# Copy dotfiles repo
COPY . /home/testuser/.dotfiles
RUN chown -R testuser:testuser /home/testuser/.dotfiles
USER testuser
WORKDIR /home/testuser/.dotfiles
ENV DOTFILES_DIR=/home/testuser/.dotfiles
# Build
RUN go build -o bin/dotfiles .
# Copy test script
COPY test/integration/test_install.sh /home/testuser/test_install.sh
CMD ["bash", "/home/testuser/test_install.sh"]
