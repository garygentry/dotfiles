FROM ubuntu:22.04
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    curl git sudo bash ca-certificates \
    software-properties-common gpg
# Install git-delta (not in Ubuntu repos, download from GitHub releases)
RUN curl -fsSL https://github.com/dandavison/delta/releases/download/0.18.2/git-delta_0.18.2_amd64.deb \
    -o /tmp/git-delta.deb && dpkg -i /tmp/git-delta.deb && rm /tmp/git-delta.deb
# Create test user with sudo
RUN useradd -m -s /bin/bash testuser && \
    echo "testuser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
# Install Go
RUN curl -fsSL https://go.dev/dl/go1.23.6.linux-amd64.tar.gz | tar -C /usr/local -xz
ENV PATH="/usr/local/go/bin:${PATH}"
# Copy dotfiles repo
COPY . /home/testuser/.dotfiles
RUN chown -R testuser:testuser /home/testuser/.dotfiles
USER testuser
WORKDIR /home/testuser/.dotfiles
ENV DOTFILES_DIR=/home/testuser/.dotfiles
ENV DOTFILES_PROFILE=test
ENV USER=testuser
# Build
RUN go build -o bin/dotfiles .
CMD ["bash", "test/integration/test_install.sh"]
