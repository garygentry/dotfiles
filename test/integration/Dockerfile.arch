FROM archlinux:latest
RUN pacman-key --init && pacman-key --populate archlinux
RUN pacman -Syu --noconfirm \
    curl git sudo bash go openssh unzip git-delta inetutils
# Create test user with sudo
RUN useradd -m -s /bin/bash testuser && \
    echo "testuser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
# Copy dotfiles repo
COPY . /home/testuser/.dotfiles
RUN chown -R testuser:testuser /home/testuser/.dotfiles
USER testuser
WORKDIR /home/testuser/.dotfiles
ENV DOTFILES_DIR=/home/testuser/.dotfiles
ENV DOTFILES_PROFILE=test
ENV USER=testuser
# Build
RUN go build -o bin/dotfiles .
CMD ["bash", "test/integration/test_install.sh"]
