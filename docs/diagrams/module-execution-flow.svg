<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 700 900" width="700" height="900">
  <title>Module Execution Flow - Module Lifecycle Phases</title>
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#4A5568"/>
    </marker>
  </defs>
  <style>
    .box { rx: 6; stroke-width: 2; fill: #DBEAFE; stroke: #3B82F6; }
    .box-shell { rx: 6; stroke-width: 2; fill: #FED7AA; stroke: #EA580C; }
    .diamond { fill: #E9D5FF; stroke: #9333EA; stroke-width: 2; }
    .label {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 13px;
      fill: #1F2937;
      text-anchor: middle;
      dominant-baseline: middle;
    }
    .label-small {
      font-size: 11px;
      fill: #6B7280;
    }
    .connector { stroke: #4A5568; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
  </style>

  <!-- Step 1: Prompts -->
  <rect class="box" x="225" y="30" width="250" height="60"/>
  <text class="label" x="350" y="60">Prompts Phase</text>
  <line class="connector" x1="350" y1="90" x2="350" y2="120"/>

  <!-- Step 2: Environment Setup -->
  <rect class="box" x="175" y="120" width="350" height="70"/>
  <text class="label" x="350" y="143">Environment Setup</text>
  <text class="label label-small" x="350" y="165">Build DOTFILES_* variables</text>
  <line class="connector" x1="350" y1="190" x2="350" y2="220"/>

  <!-- Step 3: Template Context -->
  <rect class="box" x="175" y="220" width="350" height="70"/>
  <text class="label" x="350" y="243">Template Context</text>
  <text class="label label-small" x="350" y="265">Load user, OS, secrets data</text>
  <line class="connector" x1="350" y1="290" x2="350" y2="340"/>

  <!-- Decision: OS script exists? -->
  <polygon class="diamond" points="350,340 440,390 350,440 260,390"/>
  <text class="label" x="350" y="390">OS script exists?</text>

  <!-- Yes path - Run OS script -->
  <line class="connector" x1="440" y1="390" x2="540" y2="390"/>
  <text class="label-small" x="475" y="380">Yes</text>
  <rect class="box-shell" x="540" y="360" width="130" height="60"/>
  <text class="label" x="605" y="385">Run os/<text>&lt;</text>os<text>&gt;</text>.sh</text>
  <line class="connector" x1="605" y1="420" x2="605" y2="480" x3="350" y3="480"/>
  <path class="connector" d="M 605,420 L 605,480 L 350,480"/>

  <!-- No path - Continue to install.sh -->
  <line class="connector" x1="350" y1="440" x2="350" y2="500"/>
  <text class="label-small" x="320" y="460">No</text>

  <!-- Step 5: Run install.sh -->
  <rect class="box-shell" x="225" y="500" width="250" height="60"/>
  <text class="label" x="350" y="530">Run install.sh</text>
  <line class="connector" x1="350" y1="560" x2="350" y2="590"/>

  <!-- Step 6: Deploy files -->
  <rect class="box" x="200" y="590" width="300" height="70"/>
  <text class="label" x="350" y="613">Deploy files</text>
  <text class="label label-small" x="350" y="635">symlink / copy / template</text>
  <line class="connector" x1="350" y1="660" x2="350" y2="710"/>

  <!-- Decision: verify.sh exists? -->
  <polygon class="diamond" points="350,710 440,760 350,810 260,760"/>
  <text class="label" x="350" y="760">verify.sh exists?</text>

  <!-- Yes path - Run verify.sh -->
  <line class="connector" x1="440" y1="760" x2="540" y2="760"/>
  <text class="label-small" x="475" y="750">Yes</text>
  <rect class="box-shell" x="540" y="730" width="130" height="60"/>
  <text class="label" x="605" y="760">Run verify.sh</text>
  <path class="connector" d="M 605,790 L 605,850 L 350,850"/>

  <!-- No path - Continue to Record state -->
  <line class="connector" x1="350" y1="810" x2="350" y2="820"/>
  <text class="label-small" x="320" y="825">No</text>

  <!-- Step 8: Record state -->
  <rect class="box" x="225" y="820" width="250" height="60"/>
  <text class="label" x="350" y="850">Record state</text>
</svg>
